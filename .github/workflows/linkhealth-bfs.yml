name: LinkHealth BFS (120 test)

on:
  workflow_dispatch:
    inputs:
      limit_mode:
        description: "Scegli limite"
        required: true
        type: choice
        options:
          - pages
          - total
        default: pages

      max_pages:
        description: "Max pages to crawl (usato se limit_mode=pages)"
        required: true
        default: "120"

      max_total:
        description: "Max total link checks (usato se limit_mode=total)"
        required: true
        default: "2000"

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests playwright
          python -m playwright install --with-deps chromium

      - name: Debug env (safe)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_A_ID: ${{ secrets.NOTION_DB_A_ID }}
          NOTION_DB_B_ID: ${{ secrets.NOTION_DB_B_ID }}
          SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
        run: |
          python -c "import os; t=os.getenv('NOTION_TOKEN',''); print('token_prefix', t[:7], 'len', len(t))"
          python -c "import os; print('DB_A len', len(os.getenv('NOTION_DB_A_ID','')))"
          python -c "import os; print('DB_B len', len(os.getenv('NOTION_DB_B_ID','')))"
          python -c "import os; print('SITE_BASE_URL', os.getenv('SITE_BASE_URL',''))"

      - name: Run BFS crawl
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_A_ID: ${{ secrets.NOTION_DB_A_ID }}
          NOTION_DB_B_ID: ${{ secrets.NOTION_DB_B_ID }}
          SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          # NEW: mode + limits
          LIMIT_MODE: ${{ inputs.limit_mode }}
          MAX_PAGES: ${{ inputs.max_pages }}
          MAX_TOTAL: ${{ inputs.max_total }}

          CHECK_EXTERNAL: "true"
          CHECK_INTERNAL: "true"

          # timing: evita timeout/rate limit Notion
          NOTION_MIN_INTERVAL: "1.0"
          CRAWL_SLEEP: "0.35"

          # backfill + riallineamento
          BACKFILL_MISSING: "true"
          FORCE_TOUCH_EXISTING: "true"

          # filtri utili
          SKIP_DOMAINS: "linkedin.com"
          EXCLUDE_DOM_AREAS: "Footer,Nav"

        run: |
          python bfs_crawl_360_to_notion.py